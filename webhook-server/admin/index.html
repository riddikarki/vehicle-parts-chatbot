<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Satkam Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0f1117;
      --bg-secondary: #1a1d27;
      --bg-card: #21242f;
      --bg-hover: #2a2e3b;
      --border: #2e3240;
      --text-primary: #e8eaed;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-glow: rgba(59, 130, 246, 0.15);
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --radius: 10px;
      --shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* LOGIN */
    .login-screen {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; background: var(--bg-primary);
    }
    .login-box {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 16px; padding: 48px 40px; width: 100%; max-width: 400px;
      text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .login-box h1 { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
    .login-box .subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 32px; }
    .login-box input {
      width: 100%; padding: 12px 16px; background: var(--bg-primary);
      border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace; font-size: 14px; margin-bottom: 16px;
      outline: none; transition: border-color 0.2s;
    }
    .login-box input:focus { border-color: var(--accent); }
    .login-box .login-error { color: var(--danger); font-size: 13px; margin-bottom: 12px; display: none; }
    .btn-primary {
      width: 100%; padding: 12px; background: var(--accent); color: #fff;
      border: none; border-radius: 8px; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: background 0.2s;
    }
    .btn-primary:hover { background: var(--accent-hover); }

    /* APP LAYOUT */
    .app { display: none; height: 100vh; }
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0; width: 240px;
      background: var(--bg-secondary); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; z-index: 10;
    }
    .sidebar-brand { padding: 24px 20px 20px; border-bottom: 1px solid var(--border); }
    .sidebar-brand h2 { font-size: 18px; font-weight: 700; }
    .sidebar-brand span { font-size: 12px; color: var(--text-muted); }
    .nav-items { flex: 1; padding: 12px 10px; overflow-y: auto; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 14px;
      border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;
      color: var(--text-secondary); transition: all 0.15s; margin-bottom: 2px;
    }
    .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .nav-item.active { background: var(--accent-glow); color: var(--accent); }
    .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
    .sidebar-footer {
      padding: 16px; border-top: 1px solid var(--border);
    }
    .sidebar-footer button {
      width: 100%; padding: 8px; background: transparent; border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-secondary); font-size: 13px; cursor: pointer;
      transition: all 0.2s;
    }
    .sidebar-footer button:hover { background: var(--bg-hover); color: var(--text-primary); }
    .main { margin-left: 240px; padding: 32px; overflow-y: auto; height: 100vh; }
    .section { display: none; }
    .section.active { display: block; }

    /* PAGE HEADER */
    .page-header { margin-bottom: 24px; }
    .page-header h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
    .page-header p { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
    .page-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }

    /* STATS CARDS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .stat-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 20px; transition: border-color 0.2s;
    }
    .stat-card:hover { border-color: var(--accent); }
    .stat-card .label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px; }
    .stat-card .value { font-size: 32px; font-weight: 700; letter-spacing: -1px; }
    .stat-card .value.blue { color: var(--accent); }
    .stat-card .value.green { color: var(--success); }
    .stat-card .value.yellow { color: var(--warning); }

    /* TABLE CARD */
    .table-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      overflow: hidden; margin-bottom: 24px;
    }
    .table-card-header {
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .table-card-header h3 { font-size: 15px; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left; padding: 10px 20px; font-size: 11px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted);
      border-bottom: 1px solid var(--border); background: var(--bg-secondary);
    }
    td {
      padding: 12px 20px; font-size: 13px; border-bottom: 1px solid var(--border);
      color: var(--text-secondary); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    tr:hover td { background: var(--bg-hover); }
    .badge {
      display: inline-block; padding: 3px 10px; border-radius: 12px;
      font-size: 11px; font-weight: 600; text-transform: capitalize;
    }
    .badge.pending { background: rgba(245,158,11,0.15); color: var(--warning); }
    .badge.processing { background: rgba(59,130,246,0.15); color: var(--accent); }
    .badge.completed { background: rgba(34,197,94,0.15); color: var(--success); }
    .badge.cancelled { background: rgba(239,68,68,0.15); color: var(--danger); }

    /* BUTTONS */
    .refresh-btn {
      display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px;
      background: var(--bg-hover); border: 1px solid var(--border); border-radius: 8px;
      color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    .refresh-btn:hover { background: var(--border); color: var(--text-primary); }
    .btn-action {
      padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;
      cursor: pointer; border: 1px solid var(--border); background: var(--bg-hover);
      color: var(--text-secondary); transition: all 0.15s;
    }
    .btn-action:hover { background: var(--border); color: var(--text-primary); }
    .btn-action.danger:hover { background: rgba(239,68,68,0.15); color: var(--danger); border-color: var(--danger); }
    .btn-add {
      display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px;
      background: var(--accent); color: #fff; border: none; border-radius: 8px;
      font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s;
    }
    .btn-add:hover { background: var(--accent-hover); }

    /* CONVERSATION VIEWER */
    .chat-list { max-height: 600px; overflow-y: auto; }
    .chat-session {
      border-bottom: 1px solid var(--border); padding: 16px 20px; cursor: pointer;
      transition: background 0.15s;
    }
    .chat-session:hover { background: var(--bg-hover); }
    .chat-session.active { background: var(--accent-glow); border-left: 3px solid var(--accent); }
    .chat-session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .chat-session-phone { font-weight: 600; font-size: 14px; }
    .chat-session-time { font-size: 11px; color: var(--text-muted); }
    .chat-session-preview { font-size: 12px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .chat-viewer {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      height: 600px; display: flex; flex-direction: column;
    }
    .chat-viewer-header {
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      font-weight: 600; font-size: 15px;
    }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
    .chat-bubble {
      max-width: 75%; padding: 10px 14px; border-radius: 12px;
      font-size: 13px; line-height: 1.5; margin-bottom: 10px; word-wrap: break-word;
    }
    .chat-bubble.user {
      background: var(--accent); color: #fff; margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .chat-bubble.bot {
      background: var(--bg-hover); color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }
    .chat-bubble-time { font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 4px; }
    .chat-bubble.bot .chat-bubble-time { color: var(--text-muted); }
    .conv-layout { display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    .no-chat-selected {
      display: flex; align-items: center; justify-content: center; height: 100%;
      color: var(--text-muted); font-size: 14px;
    }

    /* MODAL */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      z-index: 100; align-items: center; justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px;
      width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto;
      box-shadow: 0 16px 48px rgba(0,0,0,0.5);
    }
    .modal-header {
      padding: 20px 24px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header h3 { font-size: 16px; font-weight: 600; }
    .modal-close {
      background: none; border: none; color: var(--text-muted); font-size: 20px;
      cursor: pointer; padding: 4px 8px; border-radius: 4px;
    }
    .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-primary); font-family: 'DM Sans', sans-serif;
      font-size: 14px; outline: none; transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

    /* CONFIG SECTION */
    .config-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 20px; margin-bottom: 16px;
    }
    .config-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .config-card-header h4 { font-size: 14px; font-weight: 600; }
    .config-card-header .save-status { font-size: 12px; display: none; }
    .config-card textarea {
      width: 100%; min-height: 120px; padding: 12px; background: var(--bg-primary);
      border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.6;
      resize: vertical; outline: none; transition: border-color 0.2s;
    }
    .config-card textarea:focus { border-color: var(--accent); }
    .config-card .desc { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
    .config-save-btn {
      margin-top: 8px; padding: 6px 16px; background: var(--accent); color: #fff;
      border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;
    }
    .config-save-btn:hover { background: var(--accent-hover); }

    /* SEARCH */
    .search-bar {
      padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-primary); font-size: 14px; width: 280px;
      outline: none; transition: border-color 0.2s;
    }
    .search-bar:focus { border-color: var(--accent); }

    /* TOAST */
    .toast {
      position: fixed; bottom: 24px; right: 24px; padding: 12px 20px;
      border-radius: 10px; font-size: 13px; font-weight: 500; z-index: 200;
      transform: translateY(80px); opacity: 0; transition: all 0.3s;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--success); color: #fff; }
    .toast.error { background: var(--danger); color: #fff; }

    /* LOADING */
    .loading { padding: 40px; text-align: center; color: var(--text-muted); font-size: 13px; }
    .spinner {
      width: 24px; height: 24px; border: 2px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.6s linear infinite; margin: 0 auto 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* EMPTY STATE */
    .empty-state { padding: 60px 20px; text-align: center; color: var(--text-muted); }
    .empty-state svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3; }
    .empty-state p { font-size: 14px; }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>üîß Satkam Admin</h1>
      <p class="subtitle">Vehicle Parts Chatbot Dashboard</p>
      <p class="login-error" id="loginError">Invalid password. Please try again.</p>
      <input type="password" id="passwordInput" placeholder="Enter admin password" onkeypress="if(event.key==='Enter')doLogin()">
      <button class="btn-primary" onclick="doLogin()">Sign In</button>
    </div>
  </div>

  <!-- APP -->
  <div class="app" id="app">
    <nav class="sidebar">
      <div class="sidebar-brand">
        <h2>üîß Satkam</h2>
        <span>Admin Dashboard</span>
      </div>
      <div class="nav-items">
        <div class="nav-item active" onclick="showSection('overview')" data-section="overview">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          Overview
        </div>
        <div class="nav-item" onclick="showSection('orders')" data-section="orders">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
          Orders
        </div>
        <div class="nav-item" onclick="showSection('conversations')" data-section="conversations">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
          Conversations
        </div>
        <div class="nav-item" onclick="showSection('products')" data-section="products">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
          Products
        </div>
        <div class="nav-item" onclick="showSection('config')" data-section="config">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
          Bot Config
        </div>
      </div>
      <div class="sidebar-footer">
        <button onclick="doLogout()">Sign Out</button>
      </div>
    </nav>

    <div class="main">

      <!-- OVERVIEW -->
      <div class="section active" id="section-overview">
        <div class="page-header"><h1>Overview</h1><p>Today's chatbot activity at a glance</p></div>
        <div class="stats-grid">
          <div class="stat-card"><div class="label">Messages Today</div><div class="value blue" id="statMessages">-</div></div>
          <div class="stat-card"><div class="label">Active Sessions</div><div class="value green" id="statSessions">-</div></div>
          <div class="stat-card"><div class="label">Orders Today</div><div class="value yellow" id="statOrders">-</div></div>
          <div class="stat-card"><div class="label">Total Products</div><div class="value" id="statProducts">-</div></div>
        </div>
        <div class="table-card">
          <div class="table-card-header"><h3>Recent Orders</h3><button class="refresh-btn" onclick="loadOverview()">‚Üª Refresh</button></div>
          <div id="overviewOrdersTable"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
      </div>

      <!-- ORDERS -->
      <div class="section" id="section-orders">
        <div class="page-header-row">
          <div class="page-header"><h1>Orders</h1><p>All customer orders placed through the chatbot</p></div>
          <button class="refresh-btn" onclick="loadOrders()">‚Üª Refresh</button>
        </div>
        <div class="table-card">
          <div id="ordersTable"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
      </div>

      <!-- CONVERSATIONS -->
      <div class="section" id="section-conversations">
        <div class="page-header-row">
          <div class="page-header"><h1>Conversations</h1><p>View full customer chat threads</p></div>
          <button class="refresh-btn" onclick="loadConversations()">‚Üª Refresh</button>
        </div>
        <div class="conv-layout">
          <div class="table-card">
            <div class="table-card-header"><h3>Sessions</h3></div>
            <div class="chat-list" id="chatSessionList">
              <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
          </div>
          <div class="chat-viewer" id="chatViewer">
            <div class="chat-viewer-header" id="chatViewerHeader">Select a conversation</div>
            <div class="chat-messages" id="chatMessages">
              <div class="no-chat-selected">‚Üê Click a session to view the conversation</div>
            </div>
          </div>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div class="section" id="section-products">
        <div class="page-header-row">
          <div class="page-header"><h1>Products</h1><p>Manage your vehicle parts inventory</p></div>
          <div style="display:flex;gap:10px;align-items:center;">
            <input type="text" class="search-bar" id="productSearch" placeholder="Search products..." oninput="filterProducts()">
            <button class="btn-add" onclick="openProductModal()">+ Add Product</button>
          </div>
        </div>
        <div class="table-card">
          <div id="productsTable"><div class="loading"><div class="spinner"></div>Loading...</div></div>
        </div>
      </div>

      <!-- BOT CONFIG -->
      <div class="section" id="section-config">
        <div class="page-header"><h1>Bot Config</h1><p>Edit chatbot personality, prompts, and behavior ‚Äî changes apply instantly</p></div>
        <div id="configCards"><div class="loading"><div class="spinner"></div>Loading...</div></div>
      </div>

    </div>
  </div>

  <!-- PRODUCT MODAL -->
  <div class="modal-overlay" id="productModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="productModalTitle">Add Product</h3>
        <button class="modal-close" onclick="closeProductModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="prodEditId">
        <div class="form-row">
          <div class="form-group">
            <label>Product Code</label>
            <input type="text" id="prodCode" placeholder="e.g. BRK-TOY-COR-F001">
          </div>
          <div class="form-group">
            <label>Category</label>
            <input type="text" id="prodCategory" placeholder="e.g. brake, filter, engine">
          </div>
        </div>
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="prodName" placeholder="Full product name">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="prodDescription" placeholder="Brief product description"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Vehicle Make</label>
            <input type="text" id="prodMake" placeholder="e.g. Toyota">
          </div>
          <div class="form-group">
            <label>Vehicle Model</label>
            <input type="text" id="prodModel" placeholder="e.g. Corolla">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Unit Price (Rs.)</label>
            <input type="number" id="prodPrice" placeholder="0">
          </div>
          <div class="form-group">
            <label>Stock Quantity</label>
            <input type="number" id="prodStock" placeholder="0">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-action" onclick="closeProductModal()">Cancel</button>
        <button class="btn-add" onclick="saveProduct()">Save Product</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <script>
    let AUTH_PASSWORD = '';
    const API = '';
    let allProducts = [];
    let allConversations = [];

    // ==========================================
    // AUTH
    // ==========================================
    function doLogin() {
      const pw = document.getElementById('passwordInput').value;
      if (!pw) return;
      AUTH_PASSWORD = pw;
      fetch(`${API}/admin/stats?password=${encodeURIComponent(pw)}`)
        .then(r => {
          if (!r.ok) throw new Error('Unauthorized');
          return r.json();
        })
        .then(() => {
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('app').style.display = 'flex';
          loadOverview();
        })
        .catch(() => {
          document.getElementById('loginError').style.display = 'block';
        });
    }

    function doLogout() {
      AUTH_PASSWORD = '';
      document.getElementById('app').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('passwordInput').value = '';
      document.getElementById('loginError').style.display = 'none';
    }

    function apiUrl(path) {
      return `${API}${path}${path.includes('?') ? '&' : '?'}password=${encodeURIComponent(AUTH_PASSWORD)}`;
    }

    // ==========================================
    // NAVIGATION
    // ==========================================
    function showSection(name) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(`section-${name}`).classList.add('active');
      document.querySelector(`.nav-item[data-section="${name}"]`).classList.add('active');

      if (name === 'overview') loadOverview();
      else if (name === 'orders') loadOrders();
      else if (name === 'conversations') loadConversations();
      else if (name === 'products') loadProducts();
      else if (name === 'config') loadConfig();
    }

    // ==========================================
    // OVERVIEW
    // ==========================================
    async function loadOverview() {
      try {
        const [statsRes, ordersRes] = await Promise.all([
          fetch(apiUrl('/admin/stats')).then(r => r.json()),
          fetch(apiUrl('/admin/orders?limit=5')).then(r => r.json())
        ]);

        if (statsRes.success) {
          document.getElementById('statMessages').textContent = statsRes.stats.messages_today;
          document.getElementById('statSessions').textContent = statsRes.stats.active_sessions;
          document.getElementById('statOrders').textContent = statsRes.stats.orders_today;
          document.getElementById('statProducts').textContent = statsRes.stats.total_products || '-';
        }

        if (ordersRes.success && ordersRes.orders.length > 0) {
          document.getElementById('overviewOrdersTable').innerHTML = renderOrdersTable(ordersRes.orders);
        } else {
          document.getElementById('overviewOrdersTable').innerHTML = '<div class="empty-state"><p>No orders yet</p></div>';
        }
      } catch (err) {
        console.error('Overview error:', err);
      }
    }

    // ==========================================
    // ORDERS
    // ==========================================
    async function loadOrders() {
      try {
        const res = await fetch(apiUrl('/admin/orders?limit=50')).then(r => r.json());
        if (res.success && res.orders.length > 0) {
          document.getElementById('ordersTable').innerHTML = renderOrdersTable(res.orders);
        } else {
          document.getElementById('ordersTable').innerHTML = '<div class="empty-state"><p>No orders found</p></div>';
        }
      } catch (err) {
        document.getElementById('ordersTable').innerHTML = '<div class="empty-state"><p>Error loading orders</p></div>';
      }
    }

    function renderOrdersTable(orders) {
      let html = '<table><tr><th>Order #</th><th>Customer</th><th>Date</th><th>Amount</th><th>Status</th></tr>';
      orders.forEach(o => {
        const name = o.customer_name || o.customer_id || '-';
        const date = new Date(o.order_date).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' });
        const amount = `Rs. ${Number(o.total_amount).toLocaleString()}`;
        const status = o.status || 'pending';
        html += `<tr>
          <td style="font-family:'JetBrains Mono',monospace;font-size:12px;">${esc(o.order_number)}</td>
          <td style="color:var(--text-primary);font-weight:500;">${esc(name)}</td>
          <td>${date}</td>
          <td style="font-weight:600;">${amount}</td>
          <td><span class="badge ${status}">${status}</span></td>
        </tr>`;
      });
      html += '</table>';
      return html;
    }

    // ==========================================
    // CONVERSATIONS
    // ==========================================
    async function loadConversations() {
      try {
        const res = await fetch(apiUrl('/admin/conversations?limit=200')).then(r => r.json());
        if (!res.success) throw new Error('Failed');
        allConversations = res.conversations || [];

        // Group by session
        const sessions = {};
        allConversations.forEach(msg => {
          const key = msg.session_id || msg.phone_number;
          if (!sessions[key]) {
            sessions[key] = { phone: msg.phone_number, messages: [], lastTime: msg.timestamp, customerName: msg.customer_name };
          }
          sessions[key].messages.push(msg);
          if (msg.timestamp > sessions[key].lastTime) sessions[key].lastTime = msg.timestamp;
        });

        // Sort sessions by last activity
        const sorted = Object.entries(sessions).sort((a, b) => new Date(b[1].lastTime) - new Date(a[1].lastTime));

        let html = '';
        sorted.forEach(([sid, s]) => {
          const lastMsg = s.messages[s.messages.length - 1];
          const time = new Date(s.lastTime).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' });
          const label = s.customerName || s.phone || 'Unknown';
          const preview = lastMsg?.message_text?.substring(0, 50) || '';
          html += `<div class="chat-session" onclick="viewSession('${sid}')">
            <div class="chat-session-header">
              <span class="chat-session-phone">${esc(label)}</span>
              <span class="chat-session-time">${time}</span>
            </div>
            <div class="chat-session-preview">${esc(preview)}</div>
          </div>`;
        });

        document.getElementById('chatSessionList').innerHTML = html || '<div class="empty-state"><p>No conversations</p></div>';
        // Store for viewing
        window._sessions = sessions;
        window._sessionKeys = sorted.map(s => s[0]);
      } catch (err) {
        document.getElementById('chatSessionList').innerHTML = '<div class="empty-state"><p>Error loading</p></div>';
      }
    }

    function viewSession(sid) {
      // Highlight active
      document.querySelectorAll('.chat-session').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');

      const session = window._sessions[sid];
      if (!session) return;

      const label = session.customerName || session.phone || 'Unknown';
      document.getElementById('chatViewerHeader').textContent = `Chat with ${label}`;

      // Sort messages chronologically
      const msgs = [...session.messages].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      let html = '';
      msgs.forEach(m => {
        const type = m.message_type === 'user' ? 'user' : 'bot';
        const time = new Date(m.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        html += `<div class="chat-bubble ${type}">
          ${esc(m.message_text)}
          <div class="chat-bubble-time">${time}</div>
        </div>`;
      });

      document.getElementById('chatMessages').innerHTML = html;
      // Scroll to bottom
      const container = document.getElementById('chatMessages');
      container.scrollTop = container.scrollHeight;
    }

    // ==========================================
    // PRODUCTS
    // ==========================================
    async function loadProducts() {
      try {
        const res = await fetch(apiUrl('/admin/products')).then(r => r.json());
        if (!res.success) throw new Error('Failed');
        allProducts = res.products || [];
        renderProducts(allProducts);
      } catch (err) {
        document.getElementById('productsTable').innerHTML = '<div class="empty-state"><p>Error loading products</p></div>';
      }
    }

    function filterProducts() {
      const q = document.getElementById('productSearch').value.toLowerCase();
      if (!q) return renderProducts(allProducts);
      const filtered = allProducts.filter(p =>
        (p.name || '').toLowerCase().includes(q) ||
        (p.product_code || '').toLowerCase().includes(q) ||
        (p.category || '').toLowerCase().includes(q) ||
        (p.vehicle_make || '').toLowerCase().includes(q) ||
        (p.vehicle_model || '').toLowerCase().includes(q)
      );
      renderProducts(filtered);
    }

    function renderProducts(products) {
      if (!products.length) {
        document.getElementById('productsTable').innerHTML = '<div class="empty-state"><p>No products found</p></div>';
        return;
      }
      let html = '<table><tr><th>Code</th><th>Name</th><th>Category</th><th>Vehicle</th><th>Price</th><th>Stock</th><th>Actions</th></tr>';
      products.forEach(p => {
        const vehicle = [p.vehicle_make, p.vehicle_model].filter(Boolean).join(' ');
        html += `<tr>
          <td style="font-family:'JetBrains Mono',monospace;font-size:12px;">${esc(p.product_code)}</td>
          <td style="color:var(--text-primary);font-weight:500;">${esc(p.name)}</td>
          <td>${esc(p.category || '-')}</td>
          <td>${esc(vehicle || '-')}</td>
          <td style="font-weight:600;">Rs. ${Number(p.unit_price).toLocaleString()}</td>
          <td>${p.stock_quantity != null ? p.stock_quantity : '-'}</td>
          <td>
            <button class="btn-action" onclick='editProduct(${JSON.stringify(p)})'>Edit</button>
            <button class="btn-action danger" onclick="deleteProduct('${p.id}','${esc(p.name)}')">Delete</button>
          </td>
        </tr>`;
      });
      html += '</table>';
      document.getElementById('productsTable').innerHTML = html;
    }

    function openProductModal(product) {
      document.getElementById('productModalTitle').textContent = product ? 'Edit Product' : 'Add Product';
      document.getElementById('prodEditId').value = product?.id || '';
      document.getElementById('prodCode').value = product?.product_code || '';
      document.getElementById('prodName').value = product?.name || '';
      document.getElementById('prodCategory').value = product?.category || '';
      document.getElementById('prodDescription').value = product?.description || '';
      document.getElementById('prodMake').value = product?.vehicle_make || '';
      document.getElementById('prodModel').value = product?.vehicle_model || '';
      document.getElementById('prodPrice').value = product?.unit_price || '';
      document.getElementById('prodStock').value = product?.stock_quantity || '';
      document.getElementById('productModal').classList.add('show');
    }

    function editProduct(p) { openProductModal(p); }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('show');
    }

    async function saveProduct() {
      const id = document.getElementById('prodEditId').value;
      const product = {
        product_code: document.getElementById('prodCode').value,
        name: document.getElementById('prodName').value,
        category: document.getElementById('prodCategory').value,
        description: document.getElementById('prodDescription').value,
        vehicle_make: document.getElementById('prodMake').value,
        vehicle_model: document.getElementById('prodModel').value,
        unit_price: Number(document.getElementById('prodPrice').value) || 0,
        stock_quantity: Number(document.getElementById('prodStock').value) || 0,
        is_active: true
      };

      if (!product.product_code || !product.name) {
        showToast('Product code and name are required', 'error');
        return;
      }

      try {
        const url = id ? apiUrl(`/admin/products/${id}`) : apiUrl('/admin/products');
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(product)
        }).then(r => r.json());

        if (res.success) {
          showToast(id ? 'Product updated!' : 'Product added!', 'success');
          closeProductModal();
          loadProducts();
        } else {
          throw new Error(res.error || 'Failed');
        }
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function deleteProduct(id, name) {
      if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
      try {
        const res = await fetch(apiUrl(`/admin/products/${id}`), { method: 'DELETE' }).then(r => r.json());
        if (res.success) {
          showToast('Product deleted', 'success');
          loadProducts();
        } else {
          throw new Error(res.error);
        }
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    // ==========================================
    // BOT CONFIG
    // ==========================================
    async function loadConfig() {
      try {
        const res = await fetch(apiUrl('/admin/config')).then(r => r.json());
        if (!res.success) throw new Error('Failed');

        let html = '';
        (res.config || []).forEach(c => {
          html += `<div class="config-card">
            <div class="config-card-header">
              <h4>${esc(c.config_key)}</h4>
              <span class="save-status" id="status-${c.id}">‚úì Saved</span>
            </div>
            <textarea id="config-${c.config_key}" oninput="markUnsaved('${c.id}')">${esc(c.config_value)}</textarea>
            <div class="desc">${esc(c.description || '')}</div>
            <button class="config-save-btn" onclick="saveConfig('${c.config_key}','${c.id}')">Save</button>
          </div>`;
        });

        document.getElementById('configCards').innerHTML = html || '<div class="empty-state"><p>No config found. Run the bot_config SQL setup first.</p></div>';
      } catch (err) {
        document.getElementById('configCards').innerHTML = '<div class="empty-state"><p>Error loading config</p></div>';
      }
    }

    function markUnsaved(id) {
      const el = document.getElementById(`status-${id}`);
      el.style.display = 'inline-flex';
      el.textContent = '‚óè Unsaved';
      el.style.color = 'var(--warning)';
    }

    async function saveConfig(key, id) {
      const val = document.getElementById(`config-${key}`).value;
      const statusEl = document.getElementById(`status-${id}`);
      try {
        const res = await fetch(apiUrl(`/admin/config/${key}`), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ value: val })
        }).then(r => r.json());

        if (res.success) {
          statusEl.style.display = 'inline-flex';
          statusEl.textContent = '‚úì Saved';
          statusEl.style.color = 'var(--success)';
          showToast('Config saved!', 'success');
        } else { throw new Error(res.error); }
      } catch (err) {
        statusEl.style.display = 'inline-flex';
        statusEl.textContent = '‚úó Error';
        statusEl.style.color = 'var(--danger)';
        showToast('Failed: ' + err.message, 'error');
      }
    }

    // ==========================================
    // HELPERS
    // ==========================================
    function esc(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
